<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Server Vision Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  background: black;
  color: white;
  font-family: system-ui;
}

video {
  width: 100%;
  height: 60vh;
  object-fit: cover;
}

#overlay {
  position: absolute;
  inset: 0;
  pointer-events: none;
}

#panel {
  padding: 16px;
  text-align: center;
}

#status {
  font-size: 18px;
  margin-bottom: 12px;
}

#countdown {
  font-size: 48px;
  font-weight: 900;
}

#result img {
  width: 100%;
  margin-top: 12px;
  border-radius: 12px;
  border: 2px solid #2ecc71;
}
</style>
</head>

<body>

<video id="video" playsinline muted></video>

<div id="panel">
  <div id="status">Нажмите «Начать»</div>
  <div id="countdown"></div>
  <button id="startBtn">НАЧАТЬ (серверный тест)</button>
  <div id="result"></div>
</div>

<script>
const video = document.getElementById('video');
const startBtn = document.getElementById('startBtn');
const statusEl = document.getElementById('status');
const countdownEl = document.getElementById('countdown');
const resultEl = document.getElementById('result');

let stream;

/* ===== START ===== */
startBtn.onclick = async () => {
  startBtn.disabled = true;
  statusEl.innerText = 'Запрашиваем камеру…';

  stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;
  await video.play();

  startCountdown(5);
};

/* ===== COUNTDOWN ===== */
function startCountdown(seconds) {
  statusEl.innerText = 'Отойдите в кадр';
  countdownEl.innerText = seconds;

  const timer = setInterval(() => {
    seconds--;
    countdownEl.innerText = seconds;

    if (seconds <= 0) {
      clearInterval(timer);
      countdownEl.innerText = '';
      captureAndSend();
    }
  }, 1000);
}

/* ===== CAPTURE ===== */
function captureAndSend() {
  statusEl.innerText = 'Делаем снимок и отправляем на сервер…';

  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);

  // "отправка на сервер"
  setTimeout(() => {
    const processed = mockServerProcess(canvas);
    showResult(processed);
  }, 800);
}

/* ===== MOCK SERVER PROCESS ===== */
function mockServerProcess(sourceCanvas) {
  const canvas = document.createElement('canvas');
  canvas.width = sourceCanvas.width;
  canvas.height = sourceCanvas.height;

  const ctx = canvas.getContext('2d');
  ctx.drawImage(sourceCanvas, 0, 0);

  // фейковые точки тела
  drawPoint(ctx, canvas.width * 0.45, canvas.height * 0.45);
  drawPoint(ctx, canvas.width * 0.55, canvas.height * 0.45);
  drawPoint(ctx, canvas.width * 0.47, canvas.height * 0.65);
  drawPoint(ctx, canvas.width * 0.53, canvas.height * 0.65);

  return canvas.toDataURL('image/jpeg');
}

function drawPoint(ctx, x, y) {
  ctx.beginPath();
  ctx.arc(x, y, 12, 0, Math.PI * 2);
  ctx.fillStyle = 'red';
  ctx.fill();
}

/* ===== SHOW RESULT ===== */
function showResult(image) {
  statusEl.innerText = 'Сервер вернул обработанное изображение';
  resultEl.innerHTML = `<img src="${image}" />`;
}
</script>

</body>
</html>
